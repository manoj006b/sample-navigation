<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map My Campus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Desktop Layout */
        @media screen and (min-width: 769px) {
            body {
                flex-direction: row;
            }

            nav {
                background-color: rgb(158, 5, 228);
                width: 30%;
                min-width: 320px;
                max-width: 400px;
                height: 100vh;
                padding: 30px 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
                overflow-y: auto;
                flex-shrink: 0;
            }

            .nav-container {
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .title-container {
                text-align: center;
                margin-bottom: 40px;
            }

            .head1 {
                font-size: 2.2rem;
                font-family: Georgia, 'Times New Roman', Times, serif;
                color: white;
                margin-bottom: 10px;
                margin-top: -3%;
            }

            .input-section {
                width: 100%;
                margin-top:-5%;
            }

            .input-row {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0;
                width: 90%;
            }

            .input-wrapper {
                width: 100%;
                max-width: 100%;
                min-width: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-bottom: 0px;
            }

            #to-area {
                margin-top: -8%;
            }

            .input-label {
                color: #ffffff;
                font-size: 1.3rem;
                font-weight: bold;
                margin-bottom: 5px;
                display: block;
                width: 90%;
                text-align: left;
            }

            .input-area {
                position: relative;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            #fromBox,
            #toBox {
                background-color: #041f76;
                border-radius: 10px;
                width: 90%;
                height: 50px;
                padding: 0 15px;
                font-size: 1.1rem;
                border: 2px solid rgb(5, 5, 79);
                color: white;
                transition: border-color 0.3s;
                margin-bottom: 0;
            }

            #fromBox:focus,
            #toBox:focus {
                outline: none;
                border-color: #e0e2ea;
            }

            input::placeholder {
                color: rgba(255, 255, 255, 0.8);
            }

            .dropdown {
                margin-top: 0;
                display: none;
                position: absolute;
                top: 110%;
                left: 50%;
                transform: translateX(-50%);
                width: 88%;
                max-height: 225px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #597ae8;
                border-top: none;
                border-radius: 0 0 10px 10px;
                list-style-type: none;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(89, 87, 87, 0.1);
            }

            .dropdown li {
                padding: 10px 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                font-size: 1.3rem;
                text-align: center;
                transition: all 0.2s;
                font-family: 'Times New Roman', Times, serif;
            }

            .dropdown li:last-child {
                border-bottom: none;
            }

            .dropdown li:hover {
                background-color: #bbadad;
                color: #1a49e2;
            }

            .swap-container {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
                padding: 0;
                margin-left: 110%;
            }

            .swapbox {
                width: 50px;
                height: 50px;
                cursor: pointer;
                border-radius: 18px;
                transition: transform 0.3s;
                background-color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }

            .swapbox:hover {
                transform: scale(1.1);
            }

            .rotate-once {
                animation: rotateOnce 0.35s ease-in-out forwards;
            }

            @keyframes rotateOnce {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(180deg);
                }
            }

            .button-container {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-top: 15px;
                margin-bottom: 10px;
                width: 75%;
                margin-left: 7%;
            }

            button {
                background-color: rgb(5, 5, 79);
                color: white;
                width: 90%;
                height: 45px;
                border-radius: 18px;
                font-size: 1.2rem;
                border: 2px solid rgb(5, 5, 79);
                cursor: pointer;
                transition: all 0.3s;
                font-weight: bold;
            }

            button:hover {
                background-color: yellow;
                color: rgb(10, 10, 10);
                border-color: yellow;
                transform: translateY(-2px);
            }

            .search-icon {
                display: none;
            }

            .search-text {
                display: inline;
            }

            .map-section {
                flex: 1;
                width: 75%;
                height: 100vh;
                position: relative;
                background-color: #f5f5f5;
                overflow: hidden;
            }
        }

        /* Mobile Layout - Keep original styling */
        @media screen and (max-width: 768px) {
            nav {
                background-color: rgb(158, 5, 228);
                width: 100%;
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
            }

            .nav-container {
                width: 100%;
                max-width: 1400px;
                margin: 0 auto;
            }

            .title-container {
                text-align: center;
                margin-bottom: 30px;
            }

            .head1 {
                font-size: 2rem;
                font-family: Georgia, 'Times New Roman', Times, serif;
                color: white;
                margin-bottom: 20px;
            }

            .input-section {
                width: 100%;
                position: relative;
            }

            .input-row {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 10px 15px;
                align-items: start;
                max-width: 340px;
                margin: 0 auto 0px;
                margin-left: -2%;
            }

            .swap-container {
                grid-column: 2;
                grid-row: 1 / span 2;
                padding-top: 35px;
                margin: 0;
                width: 60px;
                display: flex;
                justify-content: center;
                margin-top: -53%;
            }

            .swapbox {
                width: 45px;
                height: 45px;
                cursor: pointer;
                border-radius: 18px;
                transition: transform 0.3s;
                background-color: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }

            .swapbox:hover {
                transform: scale(1.1);
            }

            .rotate-once {
                animation: rotateOnce 0.35s ease-in-out forwards;
            }

            @keyframes rotateOnce {
                from {
                    transform: rotate(0deg);
                }

                to {
                    transform: rotate(180deg);
                }
            }

            .input-wrapper {
                grid-column: 1;
                width: 100%;
                max-width: none;
                min-width: auto;
                margin: 0;
            }

            .input-wrapper:first-child {
                grid-row: 1;
                margin-bottom: 5px;
            }

            .input-wrapper:last-child {
                grid-row: 2;
                margin-top: 0;
            }

            .input-label {
                display: none;
            }

            .input-area {
                position: relative;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            #fromBox,
            #toBox {
                background-color: #041f76;
                border-radius: 10px;
                width: 100%;
                height: 45px;
                padding: 0 15px;
                font-size: 1.1rem;
                border: 2px solid rgb(5, 5, 79);
                color: white;
                transition: border-color 0.3s;
                margin-bottom: 0;
            }

            #fromBox:focus,
            #toBox:focus {
                outline: none;
                border-color: #e0e2ea;
            }

            input::placeholder {
                color: rgba(255, 255, 255, 0.8);
            }

            .dropdown {
                width: 97%;
                margin-top: 3%;
                height: 220px;
                font-size: 30px;
                display: none;
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                max-height: 275px;
                overflow-y: auto;
                background-color: white;
                border: 1px solid #597ae8;
                border-top: none;
                border-radius: 0 0 10px 10px;
                list-style-type: none;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(89, 87, 87, 0.1);
            }

            .dropdown li {
                padding: 10px 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                font-size: 21px;
                text-align: center;
                transition: all 0.2s;
                font-family: 'Times New Roman', Times, serif;
            }

            .dropdown li:last-child {
                border-bottom: none;
            }

            .dropdown li:hover {
                background-color: #bbadad;
                color: #1a49e2;
            }

            .button-container {
                position: absolute;
                top: 40%;
                right: -2%;
                display: block;
                flex-direction: column;
                gap: 8px;
                margin: 0;
                margin-top: 7%;
            }

            button {
                background-color: rgb(5, 5, 79);
                color: white;
                width: 40px;
                height: 40px;
                margin: 0;
                border-radius: 12px;
                font-size: 1.1rem;
                border: 2px solid rgb(5, 5, 79);
                cursor: pointer;
                transition: all 0.3s;
                font-weight: bold;
            }

            button:hover {
                background-color: yellow;
                color: rgb(10, 10, 10);
                border-color: yellow;
                transform: translateY(-2px);
            }

            .search-text {
                display: none;
            }

            .search-icon {
                display: inline;
                font-size: 20px;
            }

            .map-section {
                flex: 1;
                width: 100%;
                position: relative;
                background-color: #f5f5f5;
                overflow: hidden;
            }
        }

        .map-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .current-location-btn {
            position: absolute;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            background-color: #007bff;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .current-location-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }

        .landmark-toggle-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background-color: #28a745;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .landmark-toggle-btn:hover {
            background-color: #218838;
            transform: scale(1.1);
        }

        .landmark-toggle-btn.inactive {
            background-color: #dc3545;
        }

        .landmark-toggle-btn.inactive:hover {
            background-color: #c82333;
        }

        /* Navigation info panel */
        .nav-info-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            min-width: 280px;
            text-align: center;
        }

        .nav-info-panel.active {
            display: block;
        }

        .nav-info-distance {
            font-size: 24px;
            font-weight: bold;
            color: #1967d2;
            margin-bottom: 5px;
        }

        .nav-info-time {
            font-size: 16px;
            color: #666;
        }

        /* Custom marker styles */
        .custom-landmark-marker {
            background: none;
            border: none;
        }

        .start-marker-icon {
            background: none;
            border: none;
        }

        .end-marker-icon {
            background: none;
            border: none;
        }

        /* Sidebar Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --bg-light: #f8f9fa;
            --sidebar-bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --transition: 0.3s ease;
        }

        /* Overlay for mobile */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
            z-index: 998;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 380px;
            height: 100vh;
            background: var(--sidebar-bg);
            box-shadow: -4px 0 20px var(--shadow-dark);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            right: 0;
        }

        /* Sidebar Header */
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Sidebar Content */
        .sidebar-content {
            padding: 20px;
            flex: 1;
        }

        /* Accordion Item */
        .accordion-item {
            margin-bottom: 16px;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: var(--bg-light);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all var(--transition);
        }

        .accordion-item:hover {
            box-shadow: 0 4px 12px var(--shadow-dark);
        }

        .accordion-item summary {
            padding: 16px 20px;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-dark);
            background: white;
            transition: all var(--transition);
            user-select: none;
        }

        .accordion-item summary::-webkit-details-marker {
            display: none;
        }

        .accordion-item summary:hover {
            background: var(--bg-light);
            color: var(--accent-color);
        }

        .accordion-item[open] summary {
            background: var(--accent-color);
            color: white;
        }

        .accordion-item[open] summary .summary-icon {
            stroke: white;
        }

        .summary-icon {
            flex-shrink: 0;
            transition: all var(--transition);
        }

        .accordion-item[open] summary::after {
            content: '';
            margin-left: auto;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid white;
        }

        .accordion-item:not([open]) summary::after {
            content: '';
            margin-left: auto;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px transparent;
            border-bottom: 8px solid var(--text-dark);
        }

        /* Department List */
        .department-list {
            list-style: none;
            padding: 16px 20px;
            background: white;
        }

        .department-list li {
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--bg-light);
            border-radius: 8px;
            color: var(--text-dark);
            font-size: 0.95rem;
            transition: all var(--transition);
            border-left: 3px solid transparent;
        }

        .department-list li:hover {
            background: #e8f4fd;
            border-left-color: var(--accent-color);
            transform: translateX(4px);
        }

        .department-list li:last-child {
            margin-bottom: 0;
        }

        /* Floor Info */
        .floor-info {
            padding: 16px 20px;
            background: white;
        }

        .room-range {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 8px;
        }

        .floor-desc {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* Scrollbar Styling */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        /* Clickable location link in popup */
        .location-link {
            color: #1967d2;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .location-link:hover {
            color: #0d47a1;
            text-decoration: underline;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .sidebar.open {
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .sidebar {
                max-width: 100%;
            }

            .sidebar-header h1 {
                font-size: 1.5rem;
            }

            .accordion-item summary {
                padding: 14px 16px;
                font-size: 1rem;
            }

            .department-list li {
                padding: 10px 14px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar-header {
                padding: 20px;
            }

            .sidebar-content {
                padding: 15px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for keyboard navigation */
        .close-btn:focus,
        .accordion-item summary:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* New styles for deviation warnings */
        .deviation-warning {
            position: absolute;
            top: -50px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 90%;
            z-index: 1001;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .rerouting-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .rerouting-notification i {
            font-size: 20px;
        }

        /* Off-route indicator */
        .off-route-indicator {
            position: absolute;
            bottom: 170px;
            right: 20px;
            z-index: 1000;
            background-color: #dc3545;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .off-route-indicator.active {
            display: flex;
            animation: bounce 0.5s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        /* Route progress bar */
        .route-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            z-index: 1000;
            display: none;
        }

        .route-progress.active {
            display: block;
        }

        .route-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-container">
            <div class="title-container">
                <h1 class="head1">Map My Campus</h1>
            </div>

            <div class="input-section">
                <div class="input-row">
                    <div class="input-wrapper" id="from-area">
                        <label class="input-label" for="fromBox">From:</label>
                        <div class="input-area">
                            <input type="text" id="fromBox" placeholder="Enter Your Current Location"
                                onclick="showList('fromList')" onkeyup="filterItems('fromBox', 'fromList')">
                            <ul id="fromList" class="dropdown"></ul>
                        </div>
                    </div>

                    <div class="swap-container">
                        <div class="swapbox">‚áÑ</div>
                    </div>

                    <div class="input-wrapper" id="to-area">
                        <label class="input-label" for="toBox">To:</label>
                        <div class="input-area">
                            <input type="text" id="toBox" placeholder="Enter Your Destination"
                                onclick="showList('toList')" onkeyup="filterItems('toBox', 'toList')">
                            <ul id="toList" class="dropdown"></ul>
                        </div>
                    </div>
                </div>

                <div class="button-container">
                    <button id="but1" onclick="searchRoute()">
                        <span class="search-text">Search ‚ùØ‚ùØ</span>
                        <span class="search-icon">‚ùØ‚ùØ</span>
                    </button>
                    <button id="but2" onclick="clearRoute()">
                        <span class="search-text">Clear ‚ùå</span>
                        <span class="search-icon">‚ùå</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div id="mapSection" class="map-section">
        <button id="currentLocationBtn" class="current-location-btn">
            <i class="fas fa-location-crosshairs"></i>
        </button>
        <button id="landmarkToggleBtn" class="landmark-toggle-btn">
            <i class="fas fa-map-pin"></i>
        </button>
        <button id="offRouteIndicator" class="off-route-indicator" title="You're off route! Click to recalculate">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
        <div id="routeProgress" class="route-progress">
            <div id="routeProgressFill" class="route-progress-fill"></div>
        </div>
        <div id="navInfoPanel" class="nav-info-panel">
            <div id="navDistance" class="nav-info-distance">0.00 km</div>
            <div id="navTime" class="nav-info-time">0 min remaining</div>
        </div>
        <div id="mapContainer" class="map-container"></div>
    </div>

    <!-- Overlay for sidebar -->
    <div id="overlay" class="overlay"></div>

    <!-- Sidebar Menu -->
    <aside id="sideMenu" class="sidebar" role="complementary">
        <div class="sidebar-header">
            <h1>E Block</h1>
            <button class="close-btn" id="closeBtn" aria-label="Close sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="sidebar-content">
            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Departments
                </summary>
                <ul class="department-list">
                    <li>B.Sc Computer Science</li>
                    <li>B.Sc Computer Application</li>
                    <li>B.Sc Computer Technology</li>
                    <li>B.Sc Data Analytics</li>
                    <li>B.Sc Computer Networks</li>
                    <li>B.Sc Information Technology</li>
                    <li>M.Sc Software Systems</li>
                </ul>
            </details>

            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Ground Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E101 - E120</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>

            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    First Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E201 - E220</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>

            <details class="accordion-item">
                <summary>
                    <svg class="summary-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Second Floor
                </summary>
                <div class="floor-info">
                    <p class="room-range">Rooms: E301 - E320</p>
                    <p class="floor-desc">20 rooms available</p>
                </div>
            </details>
        </div>
    </aside>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Global variables
        let campusMap;
        let userLocationMarker;
        let accuracyCircle;
        let userWatchId = null;
        let userLatLng = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayerGroup = null;
        let landmarkMarkersLayer = null;
        let landmarksVisible = true;
        let animationFrameId = null;

        // Navigation state
        let isNavigating = false;
        let currentDestination = null;
        let fullRoutePath = [];
        let currentPathIndices = [];
        let lastUpdateTime = 0;
        const UPDATE_THRESHOLD = 2000; // 2 seconds
        const PROXIMITY_THRESHOLD = 15; // 15 meters

        // Real-time path recalculation variables
        let routeRecalculationTimer = null;
        let lastKnownPosition = null;
        let maxDeviationDistance = 50; // meters - max allowed deviation before recalculating
        let routeRecalculationInProgress = false;
        let lastRecalculationTime = 0;
        const RECALCULATION_COOLDOWN = 5000; // 5 seconds between recalculations
        let totalRouteDistance = 0;
        let distanceTraveled = 0;

        let graph = { nodes: [], edges: [] };
        let nodeIndex = new Map();
        let places = [];
        let lastResults;
        const KROUTES = 5;

        // Landmarks data for ROUTING (used for pathfinding)
        const landmarks = [
            { "id": "front", "name": "Front Gate", "lat": 11.034770, "lng": 77.033850 },
            { "id": "admiss", "name": "Admission Office", "lat": 11.032585, "lng": 77.033888 },
            { "id": "lib", "name": "Library", "lat": 11.033664, "lng": 77.033435 },
            { "id": "prin", "name": "Principal Office", "lat": 11.033269, "lng": 77.033861 },
            { "id": "sf", "name": "S F Office", "lat": 11.033111, "lng": 77.033410 },
            { "id": "aided", "name": "Aided Office", "lat": 11.033277, "lng": 77.034183 },
            { "id": "hostel", "name": "Hostel Office", "lat": 11.032646, "lng": 77.035449 },
            { "id": "can1", "name": "Canteen 1", "lat": 11.033695, "lng": 77.034336 },
            { "id": "can2", "name": "Canteen 2", "lat": 11.032013, "lng": 77.032709 },
            { "id": "grd", "name": "GRD Auditorium", "lat": 11.032415, "lng": 77.033340 },
            { "id": "indoor", "name": "Indoor Auditorium", "lat": 11.033714, "lng": 77.035304 },
            { "id": "ab", "name": "A Block", "lat": 11.033230, "lng": 77.032509 },
            { "id": "bb", "name": "B Block", "lat": 11.033238, "lng": 77.033060 },
            { "id": "cb", "name": "C Block", "lat": 11.032585, "lng": 77.033888 },
            { "id": "db", "name": "D Block", "lat": 11.033280, "lng": 77.034520 },
            { "id": "eb", "name": "E Block", "lat": 11.032854, "lng": 77.034351 },
            { "id": "fb", "name": "F Block", "lat": 11.032585, "lng": 77.033888 },
            { "id": "gb", "name": "G Block", "lat": 11.032609, "lng": 77.034594 },
            { "id": "qb", "name": "Q Block", "lat": 11.034020, "lng": 77.034499 },
            { "id": "book", "name": "Book Depot", "lat": 11.033405, "lng": 77.033032 },
            { "id": "pothigai", "name": "Pothigai Hall", "lat": 11.033372, "lng": 77.033410 },
            { "id": "bharathi", "name": "Bharathi Hostel", "lat": 11.032652, "lng": 77.035604 },
            { "id": "nri", "name": "NRI Hostel", "lat": 11.032658, "lng": 77.035785 },
            { "id": "back", "name": "Back Gate", "lat": 11.031834, "lng": 77.036534 }
        ];

        // Location markers data for MAP DISPLAY (used for showing markers on map)
        const locationmarker = [
            { "id": "front", "name": "Front Gate", "lat": 11.034820, "lng": 77.033845, "icon": "‚õ©Ô∏è" },
            { "id": "admiss", "name": "Admission Office", "lat": 11.032726, "lng": 77.033547, "icon": "üíº " },
            { "id": "lib", "name": "Library", "lat": 11.033706, "lng": 77.033437, "icon": "üìö" },
            { "id": "prin", "name": "Principal Office", "lat": 11.033200, "lng": 77.033947, "icon": "üíº" },
            { "id": "sf", "name": "S F Office", "lat": 11.033105, "lng": 77.033502, "icon": "üíº" },
            { "id": "aided", "name": "Aided Office", "lat": 11.033190, "lng": 77.034094, "icon": "üíº" },
            { "id": "hostel", "name": "Hostel Office", "lat": 11.032776, "lng": 77.035441, "icon": "üíº" },
            { "id": "can1", "name": "Canteen 1", "lat": 11.033762, "lng": 77.034287, "icon": "üçΩÔ∏è" },
            { "id": "can2", "name": "Canteen 2", "lat": 11.031994, "lng": 77.032606, "icon": "üçΩÔ∏è" },
            { "id": "grd", "name": "GRD Auditorium", "lat": 11.032361, "lng": 77.033290, "icon": "üé≠" },
            { "id": "ab", "name": "A Block", "lat": 11.033140, "lng": 77.032508, "icon": "üèõÔ∏è" },
            { "id": "bb", "name": "B Block", "lat": 11.033161, "lng": 77.033059, "icon": "üèõÔ∏è" },
            { "id": "cb", "name": "C Block", "lat": 11.032713, "lng": 77.033874, "icon": "üèõÔ∏è" },
            { "id": "db", "name": "D Block", "lat": 11.033285, "lng": 77.034627, "icon": "üèõÔ∏è" },
            { "id": "eb", "name": "E Block", "lat": 11.032845, "lng": 77.034410, "icon": "üèõÔ∏è" },
            { "id": "fb", "name": "F Block", "lat": 11.032500, "lng": 77.033893, "icon": "üèõÔ∏è" },
            { "id": "gb", "name": "G Block", "lat": 11.032389, "lng": 77.034572, "icon": "üèõÔ∏è" },
            { "id": "qb", "name": "Q Block", "lat": 11.034030, "lng": 77.034620, "icon": "üèõÔ∏è" },
            { "id": "football", "name": "FootBall Ground", "lat": 11.031483, "lng": 77.033107, "icon": "‚öΩ" },
            { "id": "Tennis", "name": "Tennis Court", "lat": 11.031824, "lng": 77.033979, "icon": "üè∏" },
            { "id": "Hockey", "name": "Hockey Ground", "lat": 11.031281, "lng": 77.033974, "icon": "üèë" },
            { "id": "Volleyball", "name": "Volleyball Court", "lat": 11.032467, "lng": 77.036240, "icon": "üèê" },
            { "id": "Khokho", "name": "Khokho Court", "lat": 11.030778, "lng": 77.033976, "icon": "üèÉ‚Äç‚ôÄÔ∏è" },
            { "id": "Basketball", "name": "Basketball Court", "lat": 11.032139, "lng": 77.036283, "icon": "üèÄ" },
            { "id": "indoor", "name": "Indoor Auditorium", "lat": 11.033304, "lng": 77.035299, "icon": "‚õπÔ∏è" },
            { "id": "Parking", "name": "Students Bike Parking Area", "lat": 11.034749, "lng": 77.034258, "icon": "üèçÔ∏è" },
            { "id": "Parking", "name": "Staff Parking", "lat": 11.034203, "lng": 77.033518, "icon": "üÖøÔ∏è" },
            { "id": "Parking", "name": "Students Car Parking Area", "lat": 11.033577, "lng": 77.036263, "icon": "üöó" },
            { "id": "back", "name": "Back Gate", "lat": 11.031834, "lng": 77.036534, "icon": "‚õ©Ô∏è" }
        ];

        const graphData = {
            "nodes": [
                { "id": "G1", "lat": 11.034820, "lng": 77.033845 },
                { "id": "G2", "lat": 11.034563, "lng": 77.033848 },
                { "id": "G3", "lat": 11.034280, "lng": 77.033855 },
                { "id": "G4", "lat": 11.034310, "lng": 77.034100 },
                { "id": "G5", "lat": 11.034325, "lng": 77.034371 },
                { "id": "G6", "lat": 11.034343, "lng": 77.034768 },
                { "id": "G7", "lat": 11.034369, "lng": 77.035226 },
                { "id": "G8", "lat": 11.034391, "lng": 77.035535 },
                { "id": "G9", "lat": 11.033964, "lng": 77.035553 },
                { "id": "G10", "lat": 11.034000, "lng": 77.035806 },
                { "id": "G11", "lat": 11.034019, "lng": 77.035980 },
                { "id": "G12", "lat": 11.034009, "lng": 77.036093 },
                { "id": "G13", "lat": 11.033956, "lng": 77.036219 },
                { "id": "G14", "lat": 11.033834, "lng": 77.036351 },
                { "id": "G15", "lat": 11.033289, "lng": 77.036422 },
                { "id": "G16", "lat": 11.032674, "lng": 77.036463 },
                { "id": "G17", "lat": 11.032278, "lng": 77.036498 },
                { "id": "G18", "lat": 11.031834, "lng": 77.036534 },
                { "id": "G19", "lat": 11.034009, "lng": 77.033856 },
                { "id": "G20", "lat": 11.033670, "lng": 77.033854 },
                { "id": "G21", "lat": 11.033666, "lng": 77.033679 },
                { "id": "G22", "lat": 11.033664, "lng": 77.033435 },
                { "id": "G23", "lat": 11.033630, "lng": 77.033403 },
                { "id": "G24", "lat": 11.033372, "lng": 77.033410 },
                { "id": "G25", "lat": 11.033250, "lng": 77.033413 },
                { "id": "G26", "lat": 11.033248, "lng": 77.033060 },
                { "id": "G27", "lat": 11.033240, "lng": 77.032791 },
                { "id": "G28", "lat": 11.033230, "lng": 77.032509 },
                { "id": "G29", "lat": 11.033111, "lng": 77.033410 },
                { "id": "G30", "lat": 11.032566, "lng": 77.033426 },
                { "id": "G31", "lat": 11.032410, "lng": 77.033432 },
                { "id": "G32", "lat": 11.032415, "lng": 77.033340 },
                { "id": "G33", "lat": 11.032410, "lng": 77.033218 },
                { "id": "G34", "lat": 11.032413, "lng": 77.032941 },
                { "id": "G35", "lat": 11.032558, "lng": 77.033215 },
                { "id": "G36", "lat": 11.032550, "lng": 77.032936 },
                { "id": "G37", "lat": 11.032545, "lng": 77.032686 },
                { "id": "G38", "lat": 11.032397, "lng": 77.032700 },
                { "id": "G39", "lat": 11.032179, "lng": 77.032700 },
                { "id": "G40", "lat": 11.032013, "lng": 77.032709 },
                { "id": "G41", "lat": 11.033400, "lng": 77.033864 },
                { "id": "G42", "lat": 11.033266, "lng": 77.033756 },
                { "id": "G43", "lat": 11.033269, "lng": 77.033861 },
                { "id": "G44", "lat": 11.033270, "lng": 77.033949 },
                { "id": "G45", "lat": 11.033277, "lng": 77.034183 },
                { "id": "G46", "lat": 11.033274, "lng": 77.034335 },
                { "id": "G47", "lat": 11.033687, "lng": 77.034317 },
                { "id": "G48", "lat": 11.033690, "lng": 77.034505 },
                { "id": "G49", "lat": 11.034020, "lng": 77.034499 },
                { "id": "G50", "lat": 11.034161, "lng": 77.034480 },
                { "id": "G51", "lat": 11.034203, "lng": 77.034380 },
                { "id": "G52", "lat": 11.033114, "lng": 77.034342 },
                { "id": "G53", "lat": 11.032854, "lng": 77.034345 },
                { "id": "G54", "lat": 11.032605, "lng": 77.034346 },
                { "id": "G55", "lat": 11.032585, "lng": 77.033888 },
                { "id": "G56", "lat": 11.032609, "lng": 77.034594 },
                { "id": "G57", "lat": 11.032630, "lng": 77.035112 },
                { "id": "G58", "lat": 11.033135, "lng": 77.035095 },
                { "id": "G59", "lat": 11.033130, "lng": 77.034715 },
                { "id": "G60", "lat": 11.033706, "lng": 77.035081 },
                { "id": "G61", "lat": 11.033711, "lng": 77.035527 },
                { "id": "G62", "lat": 11.033743, "lng": 77.035548 },
                { "id": "G63", "lat": 11.032650, "lng": 77.035551 },
                { "id": "G64", "lat": 11.032646, "lng": 77.035449 },
                { "id": "G65", "lat": 11.032638, "lng": 77.035259 },
                { "id": "G66", "lat": 11.032652, "lng": 77.035604 },
                { "id": "G67", "lat": 11.032658, "lng": 77.035785 },
                { "id": "G68", "lat": 11.032665, "lng": 77.036175 },
                { "id": "G69", "lat": 11.032188, "lng": 77.035270 },
                { "id": "G70", "lat": 11.031744, "lng": 77.035278 },
                { "id": "G71", "lat": 11.031262, "lng": 77.035285 },
                { "id": "G72", "lat": 11.030725, "lng": 77.035295 },
                { "id": "G73", "lat": 11.032163, "lng": 77.034363 },
                { "id": "G74", "lat": 11.032160, "lng": 77.033896 },
                { "id": "G75", "lat": 11.032140, "lng": 77.033440 },
                { "id": "G76", "lat": 11.032534, "lng": 77.032396 },
                { "id": "G77", "lat": 11.032587, "lng": 77.032278 },
                { "id": "G78", "lat": 11.032690, "lng": 77.032223 },
                { "id": "G79", "lat": 11.033037, "lng": 77.032115 },
                { "id": "G80", "lat": 11.033182, "lng": 77.032198 },
                { "id": "G81", "lat": 11.033232, "lng": 77.032396 },
                { "id": "G82", "lat": 11.033280, "lng": 77.034520 },
                { "id": "G83", "lat": 11.033245, "lng": 77.033032 },
                { "id": "G84", "lat": 11.033405, "lng": 77.033032 },
                { "id": "G85", "lat": 11.033714, "lng": 77.035304 }
            ],
            "edges": [
                ["G1", "G2"], ["G2", "G3"], ["G3", "G4"], ["G4", "G5"], ["G5", "G6"],
                ["G6", "G7"], ["G7", "G8"], ["G8", "G9"], ["G9", "G10"], ["G10", "G11"],
                ["G11", "G12"], ["G12", "G13"], ["G13", "G14"], ["G14", "G15"], ["G15", "G16"],
                ["G16", "G17"], ["G17", "G18"], ["G9", "G62"], ["G62", "G61"], ["G61", "G63"],
                ["G63", "G66"], ["G66", "G67"], ["G67", "G68"], ["G68", "G16"], ["G5", "G51"],
                ["G51", "G50"], ["G50", "G49"], ["G49", "G48"], ["G48", "G60"],
                ["G60", "G58"], ["G58", "G57"], ["G57", "G65"], ["G65", "G64"], ["G64", "G63"],
                ["G57", "G56"], ["G56", "G54"], ["G3", "G19"], ["G19", "G20"], ["G20", "G47"],
                ["G47", "G46"], ["G47", "G48"], ["G46", "G52"], ["G52", "G59"], ["G46", "G82"],
                ["G59", "G58"], ["G52", "G53"], ["G53", "G54"], ["G20", "G41"], ["G41", "G44"],
                ["G44", "G45"], ["G45", "G46"], ["G44", "G43"], ["G41", "G42"], ["G42", "G43"],
                ["G42", "G25"], ["G20", "G21"], ["G21", "G22"], ["G22", "G23"], ["G23", "G24"],
                ["G24", "G25"], ["G25", "G29"], ["G29", "G30"], ["G30", "G31"], ["G31", "G32"],
                ["G30", "G55"], ["G54", "G55"], ["G32", "G33"], ["G30", "G35"], ["G35", "G33"],
                ["G35", "G36"], ["G36", "G37"], ["G33", "G34"], ["G36", "G34"], ["G36", "G57"],
                ["G34", "G38"],
                ["G37", "G38"], ["G38", "G39"], ["G39", "G40"], ["G25", "G26"], ["G26", "G27"],
                ["G27", "G28"], ["G28", "G81"], ["G81", "G80"], ["G80", "G79"], ["G79", "G78"],
                ["G78", "G77"], ["G77", "G76"], ["G76", "G37"], ["G31", "G75"], ["G54", "G73"],
                ["G73", "G74"], ["G74", "G75"], ["G55", "G74"], ["G65", "G69"], ["G69", "G70"],
                ["G70", "G71"], ["G71", "G72"], ["G26", "G83"], ["G84", "G83"], ["G60", "G85"],
                ["G61", "G85"]
            ]
        };

        const locationsList = [
            'Current Location',
            'Front Gate',
            'Admission Office',
            'Library',
            'Principal Office',
            'S F Office',
            'Aided Office',
            'Hostel Office',
            'Canteen 1',
            'Canteen 2',
            'GRD Auditorium',
            'Indoor Auditorium',
            'A Block',
            'B Block',
            'C Block',
            'D Block',
            'E Block',
            'F Block',
            'G Block',
            'Q Block',
            'Book Depot',
            'Pothigai Hall',
            'Bharathi Hostel',
            'NRI Hostel',
            'Back Gate'
        ];

        const landmarkMapping = {
            'Front Gate': 'front',
            'Admission Office': 'admiss',
            'Library': 'lib',
            'Principal Office': 'prin',
            'S F Office': 'sf',
            'Aided Office': 'aided',
            'Hostel Office': 'hostel',
            'Canteen 1': 'can1',
            'Canteen 2': 'can2',
            'GRD Auditorium': 'grd',
            'Indoor Auditorium': 'indoor',
            'A Block': 'ab',
            'B Block': 'bb',
            'C Block': 'cb',
            'D Block': 'db',
            'E Block': 'eb',
            'F Block': 'fb',
            'G Block': 'gb',
            'Q Block': 'qb',
            'Book Depot': 'book',
            'Pothigai Hall': 'pothigai',
            'Bharathi Hostel': 'bharathi',
            'NRI Hostel': 'nri',
            'Back Gate': 'back'
        };

        // ‚îÄ‚îÄ‚îÄ Sidebar Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function openSidebar() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            
            sideMenu.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => {
                document.getElementById('closeBtn').focus();
            }, 100);
        }

        function closeSidebar() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            
            sideMenu.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ‚îÄ‚îÄ‚îÄ Custom Icon Factories ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function createStartIcon() {
            return L.divIcon({
                className: 'start-marker-icon',
                html: `
          <svg width="30" height="30" viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;">
            <defs>
              <filter id="startShadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="2.5" flood-color="#00000066"/>
              </filter>
            </defs>
            <circle cx="15" cy="15" r="14" fill="#000000" filter="url(#startShadow)"/>
            <circle cx="15" cy="15" r="9.5" fill="#ffffff"/>
          </svg>
        `,
                iconSize: [30, 30],
                iconAnchor: [17, 17],
                popupAnchor: [0, -18]
            });
        }

        function createEndIcon() {
            return L.divIcon({
                className: 'end-marker-icon',
                html: `
          <svg width="25" height="32" viewBox="0 0 20 36" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;">
            <defs>
              <filter id="endShadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="2.5" flood-color="#00000066"/>
              </filter>
            </defs>
            <path d="M15 0 C6.72 0 0 6.72 0 15 C0 22.5 15 42 15 42 C15 42 30 22.5 30 15 C30 6.72 23.28 0 15 0Z" fill="#e53935" filter="url(#endShadow)"/>
            <circle cx="15" cy="15" r="6.5" fill="#b71c1c"/>
            <circle cx="15" cy="15" r="3" fill="#ffffff"/>
          </svg>
        `,
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -44]
            });
        }

        // ‚îÄ‚îÄ‚îÄ Animated Polyline Function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function animatedPolyline(latlngs, options, duration = 3000) {
            const polyline = L.polyline([], options);

            const startTime = Date.now();
            const totalPoints = latlngs.length;

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const pointsToShow = Math.floor(progress * totalPoints);

                if (pointsToShow > 0) {
                    const partialCoords = latlngs.slice(0, pointsToShow);

                    if (progress < 1 && pointsToShow < totalPoints) {
                        const segmentProgress = (progress * totalPoints) - pointsToShow;
                        const currentPoint = latlngs[pointsToShow - 1];
                        const nextPoint = latlngs[pointsToShow];

                        const interpolatedLat = currentPoint[0] + (nextPoint[0] - currentPoint[0]) * segmentProgress;
                        const interpolatedLng = currentPoint[1] + (nextPoint[1] - currentPoint[1]) * segmentProgress;

                        partialCoords.push([interpolatedLat, interpolatedLng]);
                    }

                    polyline.setLatLngs(partialCoords);
                }

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animate);
                }
            }

            animate();
            return polyline;
        }

        // ‚îÄ‚îÄ‚îÄ UI Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function filterItems(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const items = Array.from(list.getElementsByTagName("li"));
            const filter = input.value.toLowerCase();

            items.forEach(item => item.style.display = "none");

            if (!filter) {
                items.forEach(item => item.style.display = "");
                return;
            }

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.startsWith(filter)) item.style.display = "";
            });

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (!text.startsWith(filter) && text.includes(filter)) item.style.display = "";
            });
        }

        function showList(listId) {
            document.querySelectorAll(".dropdown").forEach(list => list.style.display = "none");
            const list = document.getElementById(listId);
            list.style.display = "block";
        }

        function setupSwapButton() {
            const swapIcon = document.querySelector(".swapbox");
            if (swapIcon) {
                swapIcon.addEventListener("click", () => {
                    const fromBox = document.getElementById("fromBox");
                    const toBox = document.getElementById("toBox");
                    [fromBox.value, toBox.value] = [toBox.value, fromBox.value];
                    swapIcon.classList.add("rotate-once");
                    swapIcon.addEventListener("animationend", () => {
                        swapIcon.classList.remove("rotate-once");
                    }, { once: true });
                });
            }
        }

        function clearRoute() {
            document.getElementById("fromBox").value = "";
            document.getElementById("toBox").value = "";
            document.querySelectorAll(".dropdown").forEach(list => list.style.display = "none");

            // Stop navigation
            stopNavigation();

            // Hide navigation panel
            const navPanel = document.getElementById('navInfoPanel');
            if (navPanel) {
                navPanel.classList.remove('active');
            }

            // Hide progress bar
            const progressBar = document.getElementById('routeProgress');
            if (progressBar) {
                progressBar.classList.remove('active');
            }

            // Hide off-route indicator
            const offRouteIndicator = document.getElementById('offRouteIndicator');
            if (offRouteIndicator) {
                offRouteIndicator.classList.remove('active');
            }

            if (campusMap) {
                clearRoutes();
            }
        }

        function setupGlobalClickHandler() {
            document.addEventListener("click", function (e) {
                if (e.target.tagName === "LI" && e.target.closest(".dropdown")) {
                    const input = e.target.closest(".input-wrapper").querySelector("input");
                    if (input) {
                        input.value = e.target.textContent;
                        e.target.closest(".dropdown").style.display = "none";
                    }
                    return;
                }

                const isInsideInput = [...document.querySelectorAll(".input-wrapper")].some(wrapper => wrapper.contains(e.target));
                if (!isInsideInput) {
                    setTimeout(() => {
                        document.querySelectorAll(".dropdown").forEach(list => {
                            list.style.display = "none";
                        });
                    }, 100);
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ REAL-TIME PATH RECALCULATION FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function geolocationSuccess(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;
            
            const newPosition = [lat, lng];
            userLatLng = newPosition;

            // Update user marker and accuracy circle
            if (userLocationMarker) {
                campusMap.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            if (accuracyCircle) {
                campusMap.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }

            userLocationMarker = L.circleMarker(userLatLng, {
                radius: 10,
                fillColor: '#4285F4',
                color: '#ffffff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8,
                zIndexOffset: 1100
            }).addTo(campusMap);

            accuracyCircle = L.circle(userLatLng, {
                radius: accuracy,
                fillColor: '#4285F4',
                color: '#4285F4',
                weight: 1,
                opacity: 0.3,
                fillOpacity: 0.1
            }).addTo(campusMap);

            // Store last known position for deviation calculation
            lastKnownPosition = { lat, lng };

            // If navigating, check for deviation and update path
            if (isNavigating && currentDestination) {
                checkUserDeviationAndRecalculate();
                
                // Also update navigation info
                updatePathBasedOnLocation();
                
                // Update progress bar
                updateRouteProgress();
            }

            console.log(`Location: ${lat.toFixed(6)}, ${lng.toFixed(6)} - Accuracy: ${accuracy.toFixed(0)}m`);
        }

        function checkUserDeviationAndRecalculate() {
            const now = Date.now();
            
            // Throttle recalculations
            if (routeRecalculationInProgress || (now - lastRecalculationTime < RECALCULATION_COOLDOWN)) {
                return;
            }

            if (!lastKnownPosition || !fullRoutePath || fullRoutePath.length === 0) {
                return;
            }

            // Find closest point on current route
            const userPos = { lat: lastKnownPosition.lat, lng: lastKnownPosition.lng };
            let closestDistance = Infinity;
            let closestPointIndex = -1;
            let closestPointOnSegment = null;

            // Check distance to each segment of the route
            for (let i = 0; i < fullRoutePath.length - 1; i++) {
                const pointA = fullRoutePath[i];
                const pointB = fullRoutePath[i + 1];
                
                // Convert to objects for the nearestPointOnSegment function
                const a = { lat: pointA[0], lng: pointA[1] };
                const b = { lat: pointB[0], lng: pointB[1] };
                
                const nearestPoint = nearestPointOnSegment(userPos, a, b);
                const distance = hav(userPos, nearestPoint);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestPointIndex = i;
                    closestPointOnSegment = nearestPoint;
                }
            }

            console.log(`Distance to route: ${closestDistance.toFixed(2)}m, Max allowed: ${maxDeviationDistance}m`);

            // Update off-route indicator
            const offRouteIndicator = document.getElementById('offRouteIndicator');
            if (offRouteIndicator) {
                if (closestDistance > maxDeviationDistance) {
                    offRouteIndicator.classList.add('active');
                    offRouteIndicator.title = `You're ${closestDistance.toFixed(0)}m off route! Click to recalculate`;
                } else {
                    offRouteIndicator.classList.remove('active');
                }
            }

            // If user is too far from the route, recalculate
            if (closestDistance > maxDeviationDistance) {
                console.log("User deviated from route! Recalculating...");
                routeRecalculationInProgress = true;
                
                // Show notification to user
                showDeviationNotification(closestDistance);
                
                // Recalculate route from current position
                recalculateRouteFromCurrentPosition();
                
                lastRecalculationTime = now;
            } else if (closestDistance > maxDeviationDistance * 0.7) {
                // User is approaching deviation threshold - give warning
                showApproachingDeviationWarning(closestDistance);
            }
        }

        function showDeviationNotification(distance) {
            // Create or update a notification on the map
            const notification = L.popup()
                .setLatLng(userLatLng)
                .setContent(`
                    <div style="text-align: center; padding: 10px;">
                        <div style="color: #d32f2f; font-size: 18px; margin-bottom: 8px;">
                            <i class="fas fa-exclamation-triangle"></i> Off Route
                        </div>
                        <div style="font-size: 14px; margin-bottom: 10px;">
                            You're ${distance.toFixed(0)}m off the route
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            Recalculating new path...
                        </div>
                    </div>
                `)
                .openOn(campusMap);
            
            // Auto-close notification after 5 seconds
            setTimeout(() => {
                if (notification && notification.isOpen) {
                    campusMap.closePopup();
                }
            }, 5000);
        }

        function showApproachingDeviationWarning(distance) {
            // Only show warning if not already showing
            const existingWarning = document.querySelector('.deviation-warning');
            if (existingWarning) return;
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'deviation-warning';
            warningDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; color: #856404;">
                    <i class="fas fa-exclamation-circle" style="color: #ffc107;"></i>
                    <span>You're ${distance.toFixed(0)}m from the route</span>
                </div>
            `;
            
            // Add to navigation panel
            const navPanel = document.getElementById('navInfoPanel');
            if (navPanel) {
                navPanel.appendChild(warningDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.remove();
                    }
                }, 5000);
            }
        }

        function recalculateRouteFromCurrentPosition() {
            if (!isNavigating || !currentDestination || !userLatLng) {
                routeRecalculationInProgress = false;
                return;
            }

            const userPos = { lat: userLatLng[0], lng: userLatLng[1] };
            
            // Find nearest graph node to current position
            let nearestNodeId = null;
            let minDistance = Infinity;
            
            graph.nodes.forEach((node, index) => {
                const distance = hav(userPos, node);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestNodeId = index;
                }
            });

            if (nearestNodeId === null) {
                console.error("Could not find nearest graph node");
                routeRecalculationInProgress = false;
                return;
            }

            // Find destination node
            const destNodeId = nodeIndex.get(`ENT_${currentDestination.id}`);
            if (destNodeId === undefined) {
                console.error("Cannot find destination entrance node");
                routeRecalculationInProgress = false;
                return;
            }

            // Calculate new route
            const results = yensKShortests(nearestNodeId, destNodeId, KROUTES);
            if (!results.length) {
                console.error("No new path found");
                routeRecalculationInProgress = false;
                
                // Show error notification
                L.popup()
                    .setLatLng(userLatLng)
                    .setContent(`
                        <div style="text-align: center; padding: 10px;">
                            <div style="color: #d32f2f; font-size: 18px; margin-bottom: 8px;">
                                <i class="fas fa-times-circle"></i> Cannot Recalculate
                            </div>
                            <div style="font-size: 14px;">
                                Unable to find new path. Please return to the route.
                            </div>
                        </div>
                    `)
                    .openOn(campusMap);
                return;
            }

            // Update the route with new calculation
            lastResults = results;
            currentPathIndices = results[0].path;
            fullRoutePath = currentPathIndices.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
            
            // Update total route distance
            totalRouteDistance = pathDistance(currentPathIndices);
            
            // Re-render the route
            renderDynamicRoute();
            
            // Update navigation info
            const remainingDistance = pathDistance(currentPathIndices);
            updateNavigationInfo(remainingDistance);
            
            // Show success notification
            L.popup()
                .setLatLng(userLatLng)
                .setContent(`
                    <div style="text-align: center; padding: 10px;">
                        <div style="color: #388e3c; font-size: 18px; margin-bottom: 8px;">
                            <i class="fas fa-check-circle"></i> Route Updated
                        </div>
                        <div style="font-size: 14px;">
                            New path calculated successfully!
                        </div>
                    </div>
                `)
                .openOn(campusMap);
            
            routeRecalculationInProgress = false;
            
            // Auto-close success notification after 3 seconds
            setTimeout(() => {
                campusMap.closePopup();
            }, 3000);
        }

        function updateRouteProgress() {
            if (!isNavigating || !totalRouteDistance || totalRouteDistance === 0) {
                return;
            }

            const userPos = { lat: userLatLng[0], lng: userLatLng[1] };
            let closestDistance = Infinity;
            let closestIndex = -1;

            // Find closest point on route
            for (let i = 0; i < fullRoutePath.length; i++) {
                const point = fullRoutePath[i];
                const distance = hav(userPos, { lat: point[0], lng: point[1] });
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = i;
                }
            }

            if (closestIndex >= 0) {
                // Calculate distance traveled by measuring from start to closest point
                let traveled = 0;
                for (let i = 0; i < closestIndex; i++) {
                    if (i < fullRoutePath.length - 1) {
                        const pointA = fullRoutePath[i];
                        const pointB = fullRoutePath[i + 1];
                        traveled += hav({ lat: pointA[0], lng: pointA[1] }, { lat: pointB[0], lng: pointB[1] });
                    }
                }

                distanceTraveled = traveled;
                const progressPercentage = (distanceTraveled / totalRouteDistance) * 100;
                
                // Update progress bar
                const progressFill = document.getElementById('routeProgressFill');
                const progressBar = document.getElementById('routeProgress');
                if (progressFill && progressBar) {
                    progressFill.style.width = `${Math.min(progressPercentage, 100)}%`;
                    progressBar.classList.add('active');
                }
            }
        }

        // ‚îÄ‚îÄ‚îÄ CORE FUNCTIONS (Updated) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function updatePathBasedOnLocation() {
            if (!isNavigating || !userLatLng || !currentDestination || currentPathIndices.length === 0) {
                return;
            }

            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_THRESHOLD) {
                return;
            }
            lastUpdateTime = now;

            const userPos = { lat: userLatLng[0], lng: userLatLng[1] };

            // Find closest point on current path
            let closestIndex = 0;
            let minDist = Infinity;

            for (let i = 0; i < currentPathIndices.length; i++) {
                const nodeIdx = currentPathIndices[i];
                const node = graph.nodes[nodeIdx];
                const dist = hav(userPos, node);

                if (dist < minDist) {
                    minDist = dist;
                    closestIndex = i;
                }
            }

            // Remove passed waypoints if user is close enough
            if (minDist < PROXIMITY_THRESHOLD && closestIndex > 0) {
                console.log(`User passed waypoint ${closestIndex}, updating path...`);
                currentPathIndices = currentPathIndices.slice(closestIndex);
                
                // Update full route path for deviation checking
                fullRoutePath = currentPathIndices.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);

                // Recalculate remaining distance
                const remainingDistance = pathDistance(currentPathIndices);
                updateNavigationInfo(remainingDistance);

                // Re-render the route if significant portion passed
                if (closestIndex > 3) { // Only re-render if we passed at least 4 points
                    renderDynamicRoute();
                }
            } else {
                // Just update info without re-rendering
                const remainingDistance = pathDistance(currentPathIndices.slice(closestIndex));
                updateNavigationInfo(remainingDistance);
            }
        }

        function updateNavigationInfo(remainingDistance) {
            const navPanel = document.getElementById('navInfoPanel');
            const distanceEl = document.getElementById('navDistance');
            const timeEl = document.getElementById('navTime');

            if (!navPanel || !distanceEl || !timeEl) return;

            navPanel.classList.add('active');

            const km = (remainingDistance / 1000).toFixed(2);
            const mins = Math.round((remainingDistance / 1.4) / 60);

            distanceEl.textContent = `${km} km`;
            timeEl.textContent = `${mins} min remaining`;

            // Check if destination reached
            if (remainingDistance < 10) {
                distanceEl.textContent = 'Arrived!';
                timeEl.textContent = 'You have reached your destination';
                setTimeout(() => {
                    isNavigating = false;
                    navPanel.classList.remove('active');
                    
                    // Show arrival notification
                    L.popup()
                        .setLatLng(userLatLng)
                        .setContent(`
                            <div style="text-align: center; padding: 15px;">
                                <div style="color: #388e3c; font-size: 20px; margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i> Destination Reached!
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    You have arrived at your destination
                                </div>
                            </div>
                        `)
                        .openOn(campusMap);
                }, 3000);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Map initialization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function initializeMap() {
            if (campusMap) {
                campusMap.invalidateSize();
                return;
            }

            const campusCenter = L.latLng(11.033114, 77.034342);
            const campusBounds = L.latLngBounds(
                L.latLng(11.029847, 77.032077),
                L.latLng(11.035600, 77.036616)
            );

            campusMap = L.map('mapContainer', {
                maxBounds: campusBounds,
                maxBoundsViscosity: 1.0,
                minZoom: 17,
                maxZoom: 19,
                preferCanvas: true,
                attributionControl: false
            }).setView([11.033400, 77.033864], 18);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 20,
                attribution: '',
                updateWhenIdle: true,
                updateWhenZooming: false,
                keepBuffer: 2
            }).addTo(campusMap);

            loadCampusData();
            initializeLandmarkMarkers();

            console.log('Map initialized successfully');
        }

        function loadCampusData() {
            places = landmarks;
            graph = JSON.parse(JSON.stringify(graphData));
            nodeIndex = new Map(graph.nodes.map((n, i) => [n.id, i]));
            addLandmarkEntranceNodes();
            console.log('Campus data loaded successfully');
        }

        // Haversine distance
        function hav(a, b) {
            const R = 6371000;
            const toR = x => x * Math.PI / 180;
            const dLat = toR(b.lat - a.lat);
            const dLng = toR(b.lng - a.lng);
            const s = Math.sin(dLat / 2) ** 2 + Math.cos(toR(a.lat)) * Math.cos(toR(b.lat)) * Math.sin(dLng / 2) ** 2;
            return 2 * R * Math.asin(Math.sqrt(s));
        }

        function nearestPointOnSegment(p, a, b) {
            const px = p.lng, py = p.lat;
            const ax = a.lng, ay = a.lat;
            const bx = b.lng, by = b.lat;
            const ABx = bx - ax, ABy = by - ay;
            const APx = px - ax, APy = py - ay;
            const ABAB = ABx * ABx + ABy * ABy;
            const APAB = APx * ABx + APy * ABy;
            if (ABAB === 0) return { lat: a.lat, lng: a.lng };
            let t = APAB / ABAB;
            t = Math.max(0, Math.min(1, t));
            return { lat: ay + t * ABy, lng: ax + t * ABx };
        }

        function addLandmarkEntranceNodes() {
            places.forEach(p => {
                const entId = `ENT_${p.id}`;
                const entNode = { id: entId, lat: p.lat, lng: p.lng };
                graph.nodes.push(entNode);

                let bestDist = Infinity, bestNodeId = null, bestEdge = null, bestPointOnEdge = null;

                for (let i = 0; i < graph.nodes.length - 1; i++) {
                    const d = hav(p, graph.nodes[i]);
                    if (d < bestDist) { bestDist = d; bestNodeId = graph.nodes[i].id; bestEdge = null; }
                }

                for (const [aId, bId] of graph.edges) {
                    const aIdx = graph.nodes.findIndex(n => n.id === aId);
                    const bIdx = graph.nodes.findIndex(n => n.id === bId);
                    if (aIdx === -1 || bIdx === -1) continue;
                    const a = graph.nodes[aIdx], b = graph.nodes[bIdx];
                    const nearestPoint = nearestPointOnSegment(p, a, b);
                    const d = hav(p, nearestPoint);
                    if (d < bestDist) { bestDist = d; bestEdge = [aId, bId]; bestPointOnEdge = nearestPoint; bestNodeId = null; }
                }

                if (bestEdge && bestPointOnEdge) {
                    const splitNodeId = `SPLIT_${p.id}`;
                    const splitNode = { id: splitNodeId, lat: bestPointOnEdge.lat, lng: bestPointOnEdge.lng };
                    graph.nodes.push(splitNode);

                    const edgeIndex = graph.edges.findIndex(e => (e[0] === bestEdge[0] && e[1] === bestEdge[1]) || (e[0] === bestEdge[1] && e[1] === bestEdge[0]));
                    if (edgeIndex !== -1) graph.edges.splice(edgeIndex, 1);

                    graph.edges.push([bestEdge[0], splitNodeId]);
                    graph.edges.push([splitNodeId, bestEdge[1]]);
                    graph.edges.push([splitNodeId, entId]);
                } else if (bestNodeId) {
                    graph.edges.push([bestNodeId, entId]);
                }
            });

            nodeIndex = new Map(graph.nodes.map((n, i) => [n.id, i]));
        }

        function buildAdj(removedEdges = new Set(), removedNodes = new Set()) {
            const adj = Array(graph.nodes.length).fill(0).map(() => []);
            for (const [aiId, biId] of graph.edges) {
                const ai = nodeIndex.get(aiId), bi = nodeIndex.get(biId);
                if (ai == null || bi == null) continue;
                if (removedNodes.has(ai) || removedNodes.has(bi)) continue;
                const keyAB = `${ai}-${bi}`;
                const keyBA = `${bi}-${ai}`;
                if (removedEdges.has(keyAB) || removedEdges.has(keyBA)) continue;
                const a = graph.nodes[ai], b = graph.nodes[bi];
                const w = hav(a, b);
                adj[ai].push([bi, w]);
                adj[bi].push([ai, w]);
            }
            return adj;
        }

        function dijkstra(adj, src, dst) {
            const n = adj.length;
            const dist = Array(n).fill(Infinity);
            const prev = Array(n).fill(-1);
            const used = Array(n).fill(false);
            dist[src] = 0;
            const pq = [{ d: 0, i: src }];

            const pop = () => {
                if (!pq.length) return null;
                let bi = -1, bd = Infinity;
                for (let i = 0; i < pq.length; i++) {
                    if (pq[i].d < bd) { bd = pq[i].d; bi = i; }
                }
                return bi < 0 ? null : pq.splice(bi, 1)[0];
            };

            while (pq.length) {
                const cur = pop();
                if (!cur) break;
                const u = cur.i;
                if (used[u]) continue;
                used[u] = true;
                if (u === dst) break;
                for (const [v, w] of adj[u]) {
                    if (!used[v] && dist[u] + w < dist[v]) {
                        dist[v] = dist[u] + w;
                        prev[v] = u;
                        pq.push({ d: dist[v], i: v });
                    }
                }
            }

            const path = [];
            let u = dst;
            if (prev[u] === -1 && u !== src) return { path: [], distance: Infinity };
            while (u !== -1) { path.push(u); if (u === src) break; u = prev[u]; }
            path.reverse();
            return { path, distance: dist[dst] };
        }

        function pathDistance(indices) {
            let d = 0;
            for (let i = 0; i + 1 < indices.length; i++) {
                d += hav(graph.nodes[indices[i]], graph.nodes[indices[i + 1]]);
            }
            return d;
        }

        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
            return true;
        }

        function yensKShortests(i, t, K) {
            const A = [];
            const B = [];
            const adj0 = buildAdj();
            const p0 = dijkstra(adj0, i, t);
            if (!p0.path.length || !isFinite(p0.distance)) return A;
            A.push(p0);

            for (let k = 1; k < K; k++) {
                const prevPath = A[k - 1].path;
                for (let iSeg = 0; iSeg < prevPath.length - 1; iSeg++) {
                    const spurNode = prevPath[iSeg];
                    const rootPath = prevPath.slice(0, iSeg + 1);
                    const removedEdges = new Set();
                    const removedNodes = new Set();

                    for (const p of A) {
                        const candidateRoot = p.path.slice(0, iSeg + 1);
                        if (arraysEqual(candidateRoot, rootPath) && p.path.length > iSeg + 1) {
                            const u = p.path[iSeg], v = p.path[iSeg + 1];
                            removedEdges.add(`${u}-${v}`);
                            removedEdges.add(`${v}-${u}`);
                        }
                    }

                    for (const rpNode of rootPath.slice(0, -1)) { removedNodes.add(rpNode); }
                    const adj = buildAdj(removedEdges, removedNodes);
                    const spurRes = dijkstra(adj, spurNode, t);

                    if (spurRes.path.length && isFinite(spurRes.distance)) {
                        const totalPath = rootPath.slice(0, -1).concat(spurRes.path);
                        const totalDist = pathDistance(totalPath);
                        if (!B.some(b => arraysEqual(b.path, totalPath))) {
                            B.push({ path: totalPath, distance: totalDist });
                        }
                    }
                }

                if (!B.length) break;
                B.sort((a, b) => a.distance - b.distance);
                const best = B.shift();
                A.push(best);

                const uniq = [];
                for (const p of A) if (!uniq.some(q => arraysEqual(q.path, p.path))) uniq.push(p);
                uniq.sort((a, b) => a.distance - b.distance);
                A.splice(0, A.length, ...uniq);
            }
            return A;
        }

        function clearRoutes() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            if (routeLayerGroup) {
                campusMap.removeLayer(routeLayerGroup);
                routeLayerGroup = null;
            }
            if (startMarker) { campusMap.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { campusMap.removeLayer(endMarker); endMarker = null; }
        }

        function setStartEndMarkers(A, B) {
            if (startMarker) { campusMap.removeLayer(startMarker); startMarker = null; }
            if (endMarker) { campusMap.removeLayer(endMarker); endMarker = null; }

            startMarker = L.marker([A.lat, A.lng], { icon: createStartIcon(), zIndexOffset: 900 })
                .addTo(campusMap)
                .bindPopup(`<strong style="font-size:14px;">Start:</strong><br/>${A.name}`);

            endMarker = L.marker([B.lat, B.lng], { icon: createEndIcon(), zIndexOffset: 1000 })
                .addTo(campusMap)
                .bindPopup(`<strong style="font-size:14px;">Destination:</strong><br/>${B.name}`)
                .openPopup();
        }

        function renderDynamicRoute() {
            if (!isNavigating || currentPathIndices.length === 0) return;

            // Clear existing routes
            if (routeLayerGroup) {
                campusMap.removeLayer(routeLayerGroup);
                routeLayerGroup = null;
            }

            const layers = [];
            const latlngs = currentPathIndices.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);

            // Border
            const border = L.polyline(latlngs, {
                color: '#ffffff',
                weight: 10,
                opacity: 0.9,
                lineCap: 'round',
                lineJoin: 'round',
                smoothFactor: 1.0
            });

            // Main route
            const route = L.polyline(latlngs, {
                color: '#1967d2',
                weight: 6,
                opacity: 1,
                lineCap: 'round',
                lineJoin: 'round',
                smoothFactor: 1.0
            });

            layers.push(border, route);
            routeLayerGroup = L.layerGroup(layers).addTo(campusMap);

            // Update markers
            if (userLatLng && currentDestination) {
                setStartEndMarkers(
                    { lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' },
                    currentDestination
                );
            }
        }

        function renderSelectedRoute(selectedIndex) {
            const results = lastResults;
            if (!results || !results.length) return;

            clearRoutes();

            const layers = [];

            // Render alternative routes
            results.forEach((res, idx) => {
                const latlngs = res.path.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
                if (idx !== selectedIndex) {
                    const altBorder = L.polyline(latlngs, {
                        color: '#ffffff',
                        weight: 7,
                        opacity: 0.8,
                        lineCap: 'round',
                        lineJoin: 'round',
                        smoothFactor: 1.0
                    });
                    const alt = L.polyline(latlngs, {
                        color: '#8ab4f8',
                        weight: 5.5,
                        opacity: 0.7,
                        lineCap: 'round',
                        lineJoin: 'round',
                        smoothFactor: 1.0
                    });
                    alt.on('click', () => renderSelectedRoute(idx));
                    layers.push(altBorder, alt);
                }
            });

            // Render selected route with animation
            const selectedLatlngs = results[selectedIndex].path.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);

            const selectedBorder = animatedPolyline(selectedLatlngs, {
                color: '#ffffff',
                weight: 10,
                opacity: 0.9,
                lineCap: 'round',
                lineJoin: 'round',
                smoothFactor: 1.0
            }, 1500);

            const primaryRoute = animatedPolyline(selectedLatlngs, {
                color: '#1967d2',
                weight: 6,
                opacity: 1,
                lineCap: 'round',
                lineJoin: 'round',
                smoothFactor: 1.0
            }, 1500);

            layers.push(selectedBorder, primaryRoute);
            routeLayerGroup = L.layerGroup(layers).addTo(campusMap);

            // Store path for dynamic updates if using current location
            const fromVal = document.getElementById('fromBox').value;
            if (fromVal === 'Current Location') {
                fullRoutePath = selectedLatlngs;
                currentPathIndices = results[selectedIndex].path;
                totalRouteDistance = results[selectedIndex].distance;
                distanceTraveled = 0;

                const meters = results[selectedIndex].distance;
                updateNavigationInfo(meters);
                updateRouteProgress();
            }

            // Re-add markers
            if (lastResults && lastResults.length) {
                const toVal = document.getElementById('toBox').value;

                let A, B;
                if (fromVal === 'Current Location' && userLatLng) {
                    A = { lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' };
                } else {
                    A = getLandmarkByNameOrId(fromVal);
                }
                B = getLandmarkByNameOrId(toVal);

                if (A && B) setStartEndMarkers(A, B);
            }

            if (primaryRoute) {
                setTimeout(() => {
                    campusMap.fitBounds(L.polyline(selectedLatlngs).getBounds().pad(0.2));
                }, 100);
            }

            const meters = results[selectedIndex].distance;
            const mins = Math.round((meters / 1.4) / 60);
            const km = (meters / 1000).toFixed(2);
            console.log(`Route selected: ${mins} min ‚Ä¢ ${km} km`);
        }

        function getLandmarkByNameOrId(name) {
            if (name === 'Current Location') return null;
            const landmarkId = landmarkMapping[name];
            if (landmarkId) {
                return places.find(p => p.id === landmarkId);
            }
            return places.find(p => p.name === name);
        }

        function searchRoute() {
            const fromLocation = document.getElementById('fromBox').value;
            const toLocation = document.getElementById('toBox').value;

            if (!fromLocation || !toLocation) {
                alert('Please select both From and To locations');
                return;
            }

            if (!campusMap) {
                initializeMap();
                return;
            }

            startGeolocation();

            if (fromLocation === 'Current Location') {
                if (!userLatLng) {
                    alert('Waiting for your location... Please allow location access.');
                    navigator.geolocation.getCurrentPosition(
                        function (pos) {
                            userLatLng = [pos.coords.latitude, pos.coords.longitude];
                            searchRoute();
                        },
                        function (err) {
                            alert('Could not get your current location. Please select a location from the list.');
                        }
                    );
                    return;
                }

                const B = getLandmarkByNameOrId(toLocation);
                if (!B) {
                    alert('Invalid destination selected');
                    return;
                }

                // Enable navigation mode
                isNavigating = true;
                currentDestination = B;

                const userPos = { lat: userLatLng[0], lng: userLatLng[1] };
                let nearestNodeId = null;
                let minDistance = Infinity;

                graph.nodes.forEach((node, index) => {
                    const distance = hav(userPos, node);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestNodeId = index;
                    }
                });

                if (nearestNodeId === null) {
                    alert('Could not connect your location to the campus network');
                    isNavigating = false;
                    return;
                }

                const destNodeId = nodeIndex.get(`ENT_${B.id}`);
                if (destNodeId === undefined) {
                    alert('Cannot find destination entrance node');
                    isNavigating = false;
                    return;
                }

                const results = yensKShortests(nearestNodeId, destNodeId, KROUTES);
                if (!results.length) {
                    alert('No path found from your current location.');
                    isNavigating = false;
                    return;
                }

                lastResults = results;
                currentPathIndices = results[0].path;
                fullRoutePath = currentPathIndices.map(i => [graph.nodes[i].lat, graph.nodes[i].lng]);
                totalRouteDistance = results[0].distance;
                distanceTraveled = 0;
                
                setStartEndMarkers(
                    { lat: userLatLng[0], lng: userLatLng[1], name: 'Your Location' },
                    B
                );
                renderSelectedRoute(0);
                
                // Show progress bar
                const progressBar = document.getElementById('routeProgress');
                if (progressBar) {
                    progressBar.classList.add('active');
                }
                
                console.log("Route navigation started with deviation monitoring");
                
            } else {
                // Static route (not from current location)
                isNavigating = false;
                currentDestination = null;

                const navPanel = document.getElementById('navInfoPanel');
                if (navPanel) {
                    navPanel.classList.remove('active');
                }

                // Hide progress bar
                const progressBar = document.getElementById('routeProgress');
                if (progressBar) {
                    progressBar.classList.remove('active');
                }

                const A = getLandmarkByNameOrId(fromLocation);
                const B = getLandmarkByNameOrId(toLocation);

                if (!A || !B) {
                    alert('Invalid location selected');
                    return;
                }

                const si = nodeIndex.get(`ENT_${A.id}`);
                const ti = nodeIndex.get(`ENT_${B.id}`);

                if (si === undefined || ti === undefined) {
                    alert('Cannot find entrance nodes for selected locations.');
                    return;
                }

                const results = yensKShortests(si, ti, KROUTES);
                if (!results.length) {
                    alert('No path found between these locations.');
                    return;
                }

                lastResults = results;
                setStartEndMarkers(A, B);
                renderSelectedRoute(0);
            }
        }

        function initializeLandmarkMarkers() {
            if (landmarkMarkersLayer) {
                campusMap.removeLayer(landmarkMarkersLayer);
            }

            landmarkMarkersLayer = L.layerGroup().addTo(campusMap);

            locationmarker.forEach(place => {
                const icon = L.divIcon({
                    className: 'custom-landmark-marker',
                    html: `<div style="width: 33px; height: 33px; background: #e8f0fe; border: 1.5px solid #1a73e8; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer;">${place.icon || 'üìç'}</div>`,
                    iconSize: [33, 33],
                    iconAnchor: [18, 18],
                    popupAnchor: [0, -18]
                });

                const marker = L.marker([place.lat, place.lng], {
                    icon: icon,
                    title: place.name
                });

                // Create popup content with clickable link for E Block
                let popupContent;
                if (place.name === 'E Block') {
                    popupContent = `<strong style="font-size: 14px;"><a href="#" class="location-link" onclick="openSidebar(); return false;">${place.name}</a></strong>`;
                }
                else {
                    popupContent = `<strong style="font-size: 14px;">${place.name}</strong>`;
                }

                marker.bindPopup(popupContent).addTo(landmarkMarkersLayer);
            });

            console.log(`Initialized ${locationmarker.length} landmark markers`);
        }

        function toggleLandmarks() {
            if (!landmarkMarkersLayer) return;

            const toggleBtn = document.getElementById('landmarkToggleBtn');

            if (landmarksVisible) {
                campusMap.removeLayer(landmarkMarkersLayer);
                landmarksVisible = false;
                toggleBtn.classList.add('inactive');
            } else {
                campusMap.addLayer(landmarkMarkersLayer);
                landmarksVisible = true;
                toggleBtn.classList.remove('inactive');
            }
        }

        function startGeolocation() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }

            if (userWatchId) {
                navigator.geolocation.clearWatch(userWatchId);
            }

            userWatchId = navigator.geolocation.watchPosition(
                geolocationSuccess,
                geolocationError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 5000,
                    frequency: 1000 // Try to update every second
                }
            );
            
            console.log("Continuous geolocation monitoring started");
        }

        function geolocationError(err) {
            console.error('Geolocation error:', err);
            switch (err.code) {
                case err.PERMISSION_DENIED:
                    alert("Please allow geolocation access in your browser settings.");
                    break;
                case err.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case err.TIMEOUT:
                    alert("The request to get your location timed out.");
                    break;
                default:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        function centerOnUserLocation() {
            if (userLatLng) {
                campusMap.setView(userLatLng, 18);
            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (pos) {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        userLatLng = [lat, lng];
                        campusMap.setView(userLatLng, 18);
                        geolocationSuccess(pos);
                    }, geolocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                }
            }
        }

        function stopNavigation() {
            isNavigating = false;
            currentDestination = null;
            fullRoutePath = [];
            currentPathIndices = [];
            totalRouteDistance = 0;
            distanceTraveled = 0;
            
            // Clear any deviation warnings
            const warnings = document.querySelectorAll('.deviation-warning');
            warnings.forEach(warning => warning.remove());
            
            // Clear geolocation watch if no longer needed
            if (userWatchId) {
                navigator.geolocation.clearWatch(userWatchId);
                userWatchId = null;
            }
            
            console.log("Navigation stopped");
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            const fromList = document.getElementById('fromList');
            const toList = document.getElementById('toList');

            locationsList.forEach(location => {
                const li1 = document.createElement('li');
                li1.textContent = location;
                fromList.appendChild(li1);

                const li2 = document.createElement('li');
                li2.textContent = location;
                toList.appendChild(li2);
            });

            initializeMap();
            setupSwapButton();
            setupGlobalClickHandler();
            setupSidebarHandlers();

            const currentLocBtn = document.getElementById('currentLocationBtn');
            if (currentLocBtn) {
                currentLocBtn.addEventListener('click', centerOnUserLocation);
            }

            const landmarkToggleBtn = document.getElementById('landmarkToggleBtn');
            if (landmarkToggleBtn) {
                landmarkToggleBtn.addEventListener('click', toggleLandmarks);
            }

            const offRouteIndicator = document.getElementById('offRouteIndicator');
            if (offRouteIndicator) {
                offRouteIndicator.addEventListener('click', function() {
                    if (isNavigating) {
                        recalculateRouteFromCurrentPosition();
                    }
                });
            }

            console.log('Campus Navigation System initialized with real-time path recalculation');
        });

        // Sidebar event handlers
        function setupSidebarHandlers() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            const closeBtn = document.getElementById('closeBtn');

            // Close sidebar when close button is clicked
            closeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                closeSidebar();
            });

            // Close sidebar when clicking the overlay
            overlay.addEventListener('click', function() {
                closeSidebar();
            });

            // Prevent clicks inside the sidebar from closing it
            sideMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            // Close sidebar on escape key press
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sideMenu.classList.contains('open')) {
                    closeSidebar();
                }
            });

            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 768 && sideMenu.classList.contains('open')) {
                        closeSidebar();
                    }
                }, 250);
            });

            // Smooth scroll for accordion items
            const details = document.querySelectorAll('.accordion-item');
            details.forEach(detail => {
                detail.addEventListener('toggle', function() {
                    if (this.open) {
                        setTimeout(() => {
                            this.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'nearest' 
                            });
                        }, 300);
                    }
                });
            });

            // Touch swipe to close (mobile)
            let touchStartX = 0;
            let touchEndX = 0;

            sideMenu.addEventListener('touchstart', function(e) {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            sideMenu.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                
                if (swipeDistance > swipeThreshold) {
                    closeSidebar();
                }
            }, { passive: true });

            // Add fade-in animation to items when sidebar opens
            sideMenu.addEventListener('transitionend', function() {
                if (sideMenu.classList.contains('open')) {
                    const items = document.querySelectorAll('.accordion-item');
                    items.forEach((item, index) => {
                        setTimeout(() => {
                            item.style.animation = 'fadeIn 0.3s ease forwards';
                        }, index * 50);
                    });
                }
            });
        }
    </script>
</body>

</html>
